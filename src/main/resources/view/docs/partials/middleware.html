<section id="middleware">
    <h2 class="text-3xl font-bold text-white mb-6">Middleware System</h2>

    <p class="text-gray-400 mb-6">
        Intercept requests before and after controller execution with simple annotations.
    </p>

    <div class="space-y-6">
        <div>
            <div class="text-gray-400 text-sm mb-3">Basic usage</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-java">@Before(LoggingMiddleware.class)
@GET(value = "/dashboard", name = "dashboard")
private Object dashboard(Request req, Response res) {
    return render("dashboard.html", Map.of());
}</code></pre>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Chain multiple middlewares</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-java">@Before({CorsMiddleware.class, ApiKeyMiddleware.class, RateLimitMiddleware.class})
@GET(value = "/api/data", name = "api.data")
private Object data(Request req, Response res) {
    return "{ \"data\": [] }";
}</code></pre>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Before and After</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-java">@Before(TimingMiddleware.class)
@After(TimingMiddleware.class)
@GET(value = "/profile", name = "profile")
private Object profile(Request req, Response res) {
    // TimingMiddleware measures execution time
    return render("profile.html", Map.of());
}</code></pre>
            </div>
        </div>

        <div class="bg-zinc-900 border border-zinc-800 p-6 rounded mb-6">
            <div class="text-yellow-500 mb-3">ðŸ“¦ Built-in Middlewares</div>
            <div class="space-y-4 text-sm">
                <div>
                    <div class="text-white mb-1">LoggingMiddleware</div>
                    <div class="text-gray-400">Automatic logging of each request with IP and User-Agent.</div>
                    <div class="text-gray-500 text-xs mt-1">Useful for: Debugging, monitoring, audit trail</div>
                </div>
                <div>
                    <div class="text-white mb-1">CorsMiddleware</div>
                    <div class="text-gray-400">Adds CORS headers to allow cross-origin requests.</div>
                    <div class="text-gray-500 text-xs mt-1">Useful for: Public APIs, separate frontends, mobile apps</div>
                </div>
                <div>
                    <div class="text-white mb-1">RateLimitMiddleware</div>
                    <div class="text-gray-400">Limits to 100 requests/minute per IP. Returns 429 if exceeded.</div>
                    <div class="text-gray-500 text-xs mt-1">Useful for: Anti-spam protection, anti-DDoS, public endpoints</div>
                </div>
                <div>
                    <div class="text-white mb-1">TimingMiddleware</div>
                    <div class="text-gray-400">Measures execution time and adds the X-Response-Time header.</div>
                    <div class="text-gray-500 text-xs mt-1">Useful for: Performance optimization, detecting slow routes</div>
                </div>
                <div>
                    <div class="text-white mb-1">ApiKeyMiddleware</div>
                    <div class="text-gray-400">Verifies the presence of the X-API-Key header. Returns 401 if invalid.</div>
                    <div class="text-gray-500 text-xs mt-1">Useful for: Securing APIs, simple authentication</div>
                </div>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Example: Securing an API</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-java">@Before({CorsMiddleware.class, ApiKeyMiddleware.class, RateLimitMiddleware.class})
@GET(value = "/api/users", name = "api.users")
private Object users(Request req, Response res) {
    // 1. CORS headers added
    // 2. API Key validated (otherwise 401)
    // 3. Rate limit checked (otherwise 429)
    // 4. Controller executed

    return "{ \"users\": [] }";
}</code></pre>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Create a custom middleware</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-java">public class MaintenanceMiddleware implements Middleware {

    @Override
    public void handle(Request req, Response res) throws Exception {
        boolean isMaintenance = System.getenv("MAINTENANCE_MODE") != null;

        if (isMaintenance && !req.pathInfo().equals("/maintenance")) {
            res.redirect("/maintenance");
            throw new Exception("Maintenance mode");
        }
    }
}

// Usage
@Before(MaintenanceMiddleware.class)
@GET("/dashboard")
private Object dashboard(Request req, Response res) {
    return render("dashboard.html", Map.of());
}</code></pre>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Headers added automatically</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-bash"># TimingMiddleware
X-Response-Time: 42ms

# RateLimitMiddleware
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 87

# CorsMiddleware
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-CSRF-TOKEN</code></pre>
            </div>
        </div>

        <div>
            <div class="text-gray-400 text-sm mb-3">Generated logs (LoggingMiddleware)</div>
            <div class="bg-zinc-950 border border-zinc-800 p-6">
                <pre class="line-numbers"><code class="language-bash">INFO: GET /articles - IP: 192.168.1.1 - User-Agent: Mozilla/5.0...
INFO: POST /api/users - IP: 10.0.0.5 - User-Agent: PostmanRuntime/7.26.8
INFO: DELETE /articles/42 - IP: 192.168.1.1 - User-Agent: Mozilla/5.0...</code></pre>
            </div>
        </div>

        <div class="bg-zinc-900 border border-zinc-800 p-6 rounded">
            <div class="text-blue-400 mb-2">ðŸ’¡ Execution Order</div>
            <ul class="text-gray-400 text-sm space-y-1">
                <li>â€¢ @Before middlewares execute in array order</li>
                <li>â€¢ Controller executes next</li>
                <li>â€¢ @After middlewares execute after the controller</li>
                <li>â€¢ If a middleware throws an exception, execution stops</li>
                <li>â€¢ Middlewares are instantiated once (singleton)</li>
            </ul>
        </div>
    </div>
</section>
